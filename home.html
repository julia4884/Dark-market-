<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="logo">Dark Market Ultra</div>
    <nav>
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="games.html">–ò–≥—Ä—ã</a>
      <a href="movies.html">–§–∏–ª—å–º—ã</a>
      <a href="music.html">–ú—É–∑—ã–∫–∞</a>
      <a href="images.html">–ö–∞—Ä—Ç–∏–Ω–∫–∏</a>
      <a href="books.html">–ö–Ω–∏–≥–∏</a>
      <a href="apps.html">–ü—Ä–æ–≥—Ä–∞–º–º—ã</a>
      <a href="tools.html">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</a>
      <a href="donate.html">–î–æ–Ω–∞—Ç</a>
      <a href="home.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
    </nav>
  </header>

  <main>
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
    <div id="profile-section">
      <div id="avatar-block">
        <img id="avatar-img" src="default-avatar.png" alt="–ê–≤–∞—Ç–∞—Ä" width="120" height="120" />
        <input type="file" id="avatar-upload" />
        <button id="upload-avatar-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
        <progress id="avatar-progress" max="100" value="0" style="display:none;"></progress>
      </div>

      <h2>
        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, 
        <span id="username"></span> 
        <span id="role-badge"></span>
      </h2>
      <p>–°—Ç–∞—Ç—É—Å: <span id="status"></span></p>
      <p>–ü–æ–¥–ø–∏—Å–∫–∞: <span id="subscription"></span></p>
      
      <label for="about">–û —Å–µ–±–µ:</label>
      <textarea id="about" rows="4" cols="40"></textarea>
      <button id="save-about">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div id="admin-section" style="display:none;">
      <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
      <input type="text" id="ban-user-email" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
      <button id="ban-user-btn">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
      <br><br>
      <input type="text" id="ban-app-id" placeholder="ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è">
      <button id="ban-app-btn">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
    </div>
  </main>

  <script src="script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");

      if (!token) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");
        window.location.href = "index.html";
        return;
      }

      try {
        const res = await fetch("/profile", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();

        if (!res.ok || data.error) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –≤—ã –∑–∞–±–∞–Ω–µ–Ω—ã");
          localStorage.clear();
          window.location.href = "index.html";
          return;
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        document.getElementById("username").textContent = data.username;

        if (data.role === "admin") {
          document.getElementById("role-badge").innerHTML = " üëë";
          document.getElementById("role-badge").classList.add("admin-badge");
          document.getElementById("admin-section").style.display = "block";
        }

        document.getElementById("status").textContent = data.role;
        document.getElementById("subscription").textContent = data.subscription || "–ù–µ—Ç";

        // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä
        if (data.avatarUrl) {
          document.getElementById("avatar-img").src = data.avatarUrl;
        }

        // –ü–æ–ª–µ "–û —Å–µ–±–µ"
        document.getElementById("about").value = data.about || "";

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ "–û —Å–µ–±–µ"
        document.getElementById("save-about").onclick = async () => {
          const aboutText = document.getElementById("about").value;
          const resp = await fetch("/update-about", {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ about: aboutText })
          });
          if (resp.ok) {
            alert("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
          } else {
            alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
          }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
        document.getElementById("upload-avatar-btn").onclick = async () => {
          const file = document.getElementById("avatar-upload").files[0];
          if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");

          const formData = new FormData();
          formData.append("avatar", file);

          const progress = document.getElementById("avatar-progress");
          progress.style.display = "block";

          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/upload-avatar");
          xhr.setRequestHeader("Authorization", `Bearer ${token}`);
          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              progress.value = (event.loaded / event.total) * 100;
            }
          };
          xhr.onload = () => {
            if (xhr.status === 200) {
              alert("–ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω");
              const response = JSON.parse(xhr.responseText);
              document.getElementById("avatar-img").src = response.avatarUrl;
              progress.style.display = "none";
            } else {
              alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞");
            }
          };
          xhr.send(formData);
        };

      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è:", err);
        localStorage.clear();
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
