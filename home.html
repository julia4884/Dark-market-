<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî Dark Market Ultra</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="logo">üåå Dark Market Ultra</div>
    <nav>
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="games.html">–ò–≥—Ä—ã</a>
      <a href="movies.html">–§–∏–ª—å–º—ã</a>
      <a href="music.html">–ú—É–∑—ã–∫–∞</a>
      <a href="images.html">–ö–∞—Ä—Ç–∏–Ω–∫–∏</a>
      <a href="books.html">–ö–Ω–∏–≥–∏</a>
      <a href="apps.html">–ü—Ä–æ–≥—Ä–∞–º–º—ã</a>
      <a href="tools.html">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</a>
      <a href="donate.html">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
    </nav>
  </header>

  <main>
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <section id="profile">
      <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
      <div id="userInfo">
        <img id="avatarPreview" src="default-avatar.png" alt="–ê–≤–∞—Ç–∞—Ä" width="120">
        <p><strong>–ù–∏–∫:</strong> <span id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        <p><strong>Email:</strong> <span id="email">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
      </div>
      <form id="avatarForm">
        <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä:</label>
        <input type="file" id="avatarFile" accept="image/*" required>
        <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </form>
      <progress id="avatarProgress" value="0" max="100" style="display:none;"></progress>
    </section>

    <!-- –û —Å–µ–±–µ -->
    <section id="aboutMeSection">
      <h2>–û —Å–µ–±–µ</h2>
      <textarea id="aboutMe" rows="5" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ..."></textarea>
      <button id="saveAbout">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <p id="aboutMsg"></p>
    </section>

    <!-- –§–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <section id="myFiles">
      <h2>–í–∞—à–∏ —Ñ–∞–π–ª—ã</h2>
      <ul id="filesList"></ul>
    </section>

    <!-- –ê–¥–º–∏–Ω—Å–∫–∏–π —Ä–∞–∑–¥–µ–ª -->
    <section id="adminPanel" style="display:none;">
      <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å üëë</h2>
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
      <form id="blockUserForm">
        <input type="email" id="blockUserEmail" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
        <button type="submit">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
      </form>
      <p id="blockUserMsg"></p>

      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏</h3>
      <form id="blockAppForm">
        <input type="text" id="blockAppName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è" required>
        <button type="submit">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
      </form>
      <p id="blockAppMsg"></p>
    </section>
  </main>

  <script>
    const backendUrl = "https://dark-market-backend.onrender.com";
    const token = localStorage.getItem("token");

    if (!token) {
      window.location.href = "index.html"; // –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –≤—ã–∫–∏–¥—ã–≤–∞–µ–º –Ω–∞ –≤—Ö–æ–¥
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
        const res = await fetch(`${backendUrl}/me`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById("username").textContent = data.username;
          document.getElementById("email").textContent = data.email;
          document.getElementById("status").textContent = data.status;

          if (data.avatarUrl) {
            document.getElementById("avatarPreview").src = data.avatarUrl;
          }

          if (data.aboutMe) {
            document.getElementById("aboutMe").value = data.aboutMe;
          }

          if (data.username === "administrator") {
            document.getElementById("username").innerHTML = data.username + " üëë";
            document.getElementById("adminPanel").style.display = "block";
          }

          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
          loadUserFiles();
        } else {
          window.location.href = "index.html";
        }
      } catch {
        window.location.href = "index.html";
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
    document.getElementById("avatarForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = document.getElementById("avatarFile").files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("avatar", file);

      const progressBar = document.getElementById("avatarProgress");
      progressBar.style.display = "block";

      const xhr = new XMLHttpRequest();
      xhr.open("POST", `${backendUrl}/upload-avatar`);
      xhr.setRequestHeader("Authorization", `Bearer ${token}`);

      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percent = (event.loaded / event.total) * 100;
          progressBar.value = percent;
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          const res = JSON.parse(xhr.responseText);
          document.getElementById("avatarPreview").src = res.url;
          progressBar.style.display = "none";
        } else {
          alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞");
        }
      };

      xhr.send(formData);
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ "–û —Å–µ–±–µ"
    document.getElementById("saveAbout").addEventListener("click", async () => {
      const aboutMe = document.getElementById("aboutMe").value;
      try {
        const res = await fetch(`${backendUrl}/about-me`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ aboutMe })
        });
        if (res.ok) {
          document.getElementById("aboutMsg").textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
        } else {
          document.getElementById("aboutMsg").textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.";
        }
      } catch {
        document.getElementById("aboutMsg").textContent = "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.";
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUserFiles() {
      try {
        const res = await fetch(`${backendUrl}/my-files`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const files = await res.json();
        const list = document.getElementById("filesList");
        list.innerHTML = "";
        files.forEach(f => {
          const li = document.createElement("li");
          li.textContent = f.name;
          list.appendChild(li);
        });
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:", err);
      }
    }

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById("blockUserForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("blockUserEmail").value;
      try {
        const res = await fetch(`${backendUrl}/block-user`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email })
        });
        document.getElementById("blockUserMsg").textContent =
          res.ok ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" : "–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ";
      } catch {
        document.getElementById("blockUserMsg").textContent = "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
      }
    });

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.getElementById("blockAppForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const appName = document.getElementById("blockAppName").value;
      try {
        const res = await fetch(`${backendUrl}/block-app`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ appName })
        });
        document.getElementById("blockAppMsg").textContent =
          res.ok ? "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ" : "–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ";
      } catch {
        document.getElementById("blockAppMsg").textContent = "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
      }
    });
  </script>
</body>
</html>
