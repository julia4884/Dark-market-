<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî Dark Market Ultra</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="home.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        <a href="games.html">–ò–≥—Ä—ã</a>
        <a href="movies.html">–§–∏–ª—å–º—ã</a>
        <a href="music.html">–ú—É–∑—ã–∫–∞</a>
        <a href="images.html">–ö–∞—Ä—Ç–∏–Ω–∫–∏</a>
        <a href="books.html">–ö–Ω–∏–≥–∏</a>
        <a href="apps.html">–ü—Ä–æ–≥—Ä–∞–º–º—ã</a>
        <a href="tools.html">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</a>
    </nav>

    <main>
        <h1 class="neon-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <div id="profileInfo">
            <img id="profilePhoto" src="default-avatar.png" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" class="profile-photo">
            <h2 id="username"></h2>
            <p><strong>Email:</strong> <span id="email"></span></p>
            <p><strong>–ü–æ–¥–ø–∏—Å–∫–∞:</strong> <span id="subscription"></span></p>
            <p><strong>–†–æ–ª—å:</strong> <span id="role"></span></p>
            <p><strong>–û —Å–µ–±–µ:</strong> <span id="about"></span></p>

            <input type="file" id="photoInput">
            <button onclick="uploadPhoto()" class="neon-button">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>

        <hr>

        <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h2>
        <select id="sectionSelect">
            <option value="images">–ö–∞—Ä—Ç–∏–Ω–∫–∏</option>
            <option value="books">–ö–Ω–∏–≥–∏</option>
            <option value="games">–ò–≥—Ä—ã</option>
            <option value="movies">–§–∏–ª—å–º—ã</option>
            <option value="music">–ú—É–∑—ã–∫–∞</option>
            <option value="apps">–ü—Ä–æ–≥—Ä–∞–º–º—ã</option>
            <option value="tools">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</option>
        </select>
        <input type="text" id="fileTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞">
        <input type="number" id="filePrice" placeholder="–¶–µ–Ω–∞ (0 ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ)">
        <input type="file" id="fileInput">
        <button onclick="uploadFile()" class="neon-button">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <progress id="uploadProgress" value="0" max="100" style="width:100%;"></progress>
        <p id="uploadStatus"></p>

        <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        <section id="adminPanel" class="admin-panel" style="display:none;">
            <h2>üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <div>
                <input type="text" id="blockUserEmail" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <button id="blockUserBtn" class="neon-button">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
            <div>
                <input type="text" id="blockAppName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞">
                <button id="blockAppBtn" class="neon-button">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç</button>
            </div>
        </section>
    </main>

    <script>
        const API_URL = "https://dark-market-backend.onrender.com";

        // === –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ===
        async function loadProfile() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");
                window.location.href = "index.html";
                return;
            }

            const res = await fetch(API_URL + "/profile", {
                headers: { Authorization: "Bearer " + token }
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById("username").innerHTML =
                    data.username + (data.role === "admin" ? " üëë" : "");
                document.getElementById("email").textContent = data.email;
                document.getElementById("subscription").textContent = data.subscription;
                document.getElementById("role").textContent = data.role;
                document.getElementById("about").textContent = data.about || "–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
                if (data.photo) {
                    document.getElementById("profilePhoto").src = API_URL + data.photo;
                }
                if (data.role === "admin") {
                    document.getElementById("adminPanel").style.display = "block";
                }
            } else {
                alert("–û—à–∏–±–∫–∞: " + data.error);
            }
        }

        // === –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è ===
        async function uploadPhoto() {
            const token = localStorage.getItem("token");
            const input = document.getElementById("photoInput");
            if (!input.files.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ!");

            const formData = new FormData();
            formData.append("photo", input.files[0]);

            const res = await fetch(API_URL + "/upload-photo", {
                method: "POST",
                headers: { Authorization: "Bearer " + token },
                body: formData
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById("profilePhoto").src = API_URL + data.photo;
                alert("–§–æ—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + data.error);
            }
        }

        // === –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º ===
        async function uploadFile() {
            const token = localStorage.getItem("token");
            const section = document.getElementById("sectionSelect").value;
            const title = document.getElementById("fileTitle").value;
            const price = document.getElementById("filePrice").value || 0;
            const input = document.getElementById("fileInput");

            if (!input.files.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");

            const formData = new FormData();
            formData.append("file", input.files[0]);
            formData.append("title", title);
            formData.append("price", price);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", API_URL + `/upload-${section}`, true);
            xhr.setRequestHeader("Authorization", "Bearer " + token);

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percent = (event.loaded / event.total) * 100;
                    document.getElementById("uploadProgress").value = percent;
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        document.getElementById("uploadStatus").textContent = "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!";
                        document.getElementById("uploadProgress").value = 0;
                    } else {
                        document.getElementById("uploadStatus").textContent = "–û—à–∏–±–∫–∞: " + response.error;
                    }
                } else {
                    document.getElementById("uploadStatus").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!";
                }
            };

            xhr.send(formData);
        }

        // === –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
        document.getElementById("blockUserBtn")?.addEventListener("click", async () => {
            const email = document.getElementById("blockUserEmail").value;
            if (!email) return alert("–í–≤–µ–¥–∏—Ç–µ email!");
            const res = await fetch(API_URL + "/admin/block-user", {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: "Bearer " + localStorage.getItem("token") },
                body: JSON.stringify({ email })
            });
            const data = await res.json();
            alert(data.message);
        });

        document.getElementById("blockAppBtn")?.addEventListener("click", async () => {
            const appName = document.getElementById("blockAppName").value;
            if (!appName) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");
            const res = await fetch(API_URL + "/admin/block-app", {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: "Bearer " + localStorage.getItem("token") },
                body: JSON.stringify({ appName })
            });
            const data = await res.json();
            alert(data.message);
        });

        loadProfile();
    </script>
</body>
</html>
