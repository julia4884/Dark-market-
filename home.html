<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî Dark Market</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="logo">‚ú¶ Dark Market ‚ú¶</div>
    <nav>
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="home.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
    </nav>
  </header>

  <main>
    <h1>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h1>
    <div id="profile">
      <img id="avatar" src="uploads/avatars/default.png" alt="–ê–≤–∞—Ç–∞—Ä">
      <p><span id="email"></span> <span id="role-badge"></span></p>
      <p>–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: <span id="subscription">‚Äî</span></p>
      <input type="file" id="avatar-input">
      <button id="upload-avatar-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
      <progress id="upload-progress" max="100" value="0" style="display:none;"></progress>
      <textarea id="about" placeholder="–û —Å–µ–±–µ..."></textarea>
      <button id="save-about-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="logout-btn">–í—ã–π—Ç–∏</button>
    </div>

    <div id="admin-tools" style="display:none;">
      <h2>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∞</h2>
      <button>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
      <button>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</button>
    </div>
  </main>

  <div id="bat"></div>
  <div id="cat" title="–ù–∞–∂–º–∏ –Ω–∞ –º–µ–Ω—è!"></div>
  <div id="cat-dialog" class="hidden">
    <p>–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –∂–∞–ª–æ–±—ã?<br>–ù–∞–ø–∏—à–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É!</p>
    <form id="contact-form">
      <textarea placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
    <button id="close-dialog">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <script>
    const backendUrl = "https://dark-market-backend.onrender.com";
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "index.html";

    async function loadProfile() {
      const res = await fetch(`${backendUrl}/profile`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (res.ok) {
        document.getElementById("email").textContent = data.email;
        document.getElementById("subscription").textContent = data.subscription || "–ù–µ—Ç";
        if (data.role === "admin") {
          document.getElementById("role-badge").textContent = "üëë";
          document.getElementById("admin-tools").style.display = "block";
        }
        if (data.avatar) document.getElementById("avatar").src = data.avatar;
        if (data.about) document.getElementById("about").value = data.about;
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
        localStorage.clear();
        window.location.href = "index.html";
      }
    }

    document.getElementById("upload-avatar-btn").onclick = async () => {
      const file = document.getElementById("avatar-input").files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("avatar", file);

      const progressBar = document.getElementById("upload-progress");
      progressBar.style.display = "block";

      const xhr = new XMLHttpRequest();
      xhr.open("POST", `${backendUrl}/upload-avatar`);
      xhr.setRequestHeader("Authorization", `Bearer ${token}`);
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          progressBar.value = (e.loaded / e.total) * 100;
        }
      };
      xhr.onload = () => {
        if (xhr.status === 200) {
          alert("–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!");
          loadProfile();
        } else {
          alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞");
        }
      };
      xhr.send(formData);
    };

    document.getElementById("save-about-btn").onclick = async () => {
      const about = document.getElementById("about").value;
      const res = await fetch(`${backendUrl}/update-about`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ about })
      });
      if (res.ok) alert("–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
    };

    document.getElementById("logout-btn").onclick = () => {
      localStorage.clear();
      window.location.href = "index.html";
    };

    // –ö–æ—à–∫–∞
    const cat = document.getElementById("cat");
    const dialog = document.getElementById("cat-dialog");
    const closeBtn = document.getElementById("close-dialog");

    cat.onclick = () => dialog.classList.remove("hidden");
    closeBtn.onclick = () => dialog.classList.add("hidden");

    document.getElementById("contact-form").onsubmit = (e) => {
      e.preventDefault();
      alert("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É!");
      dialog.classList.add("hidden");
    };

    loadProfile();
  </script>
  <script src="script.js"></script>
</body>
</html>
