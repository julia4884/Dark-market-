<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî Dark Market Ultra</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background:#111; color:#eee; font-family:Arial,sans-serif; text-align:center; padding:20px; }
        nav a { margin:0 10px; color:#eee; text-decoration:none; }
        nav a:hover { color:crimson; }
        .gallery { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px; margin-top:20px; }
        .image-card { background:#1c1c1c; padding:15px; border-radius:8px; transition:transform 0.2s; }
        .image-card:hover { transform:scale(1.05); }
        .image-card img { width:100%; height:200px; object-fit:cover; border-radius:6px; }
        .price { color:crimson; font-weight:bold; margin:8px 0; }
        button { background:crimson; border:none; padding:8px 15px; border-radius:6px; color:white; cursor:pointer; }
        button:hover { background:darkred; }
        #dev-panel { margin-top:30px; padding:20px; background:#1c1c1c; border-radius:10px; display:none; }
        input { margin:5px; padding:8px; width:80%; background:#222; color:#eee; border:none; border-radius:6px; }
    </style>
</head>
<body>
<header>
    <h1>–ö–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî Dark Market Ultra</h1>
    <nav>
        <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="home.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        <a href="games.html">–ò–≥—Ä—ã</a>
        <a href="movies.html">–§–∏–ª—å–º—ã</a>
        <a href="music.html">–ú—É–∑—ã–∫–∞</a>
        <a href="images.html">–ö–∞—Ä—Ç–∏–Ω–∫–∏</a>
        <a href="books.html">–ö–Ω–∏–≥–∏</a>
        <a href="apps.html">–ü—Ä–æ–≥—Ä–∞–º–º—ã</a>
        <a href="tools.html">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</a>
    </nav>
    <p>–ü—Ä–µ–≤—å—é –±–µ—Å–ø–ª–∞—Ç–Ω—ã. –ü–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ üíé</p>
</header>

<main>
    <div class="gallery" id="gallery"></div>

    <!-- –ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
    <section id="dev-panel">
        <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</h2>
        <input type="file" id="imageUpload" accept="image/*"><br>
        <input type="text" id="imageTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><br>
        <input type="number" step="0.01" id="imagePrice" placeholder="–¶–µ–Ω–∞ (‚Ç¨)"><br>
        <button id="uploadImageBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </section>
</main>

<footer>
    <p>¬© Dark Market Ultra ¬© 2025</p>
</footer>

<script src="config.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("token");
    const gallery = document.getElementById("gallery");

    try {
        const res = await fetch(`${API_URL}/images/list`);
        const data = await res.json();

        gallery.innerHTML = "";
        if (data.success && data.images.length > 0) {
            data.images.forEach(img => {
                const div = document.createElement("div");
                div.className = "image-card";
                div.innerHTML = `
                    <img src="${API_URL + img.preview}" alt="${img.title}">
                    <p><b>${img.title}</b></p>
                    <p class="price">${img.price} ‚Ç¨</p>
                    <div id="actions-${img.id}">
                        <button onclick="buyImage(${img.id})">–ö—É–ø–∏—Ç—å</button>
                    </div>
                `;
                gallery.appendChild(div);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫—É–ø–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫—É
                if (token) checkPurchase(img.id);
            });
        } else {
            gallery.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫.</p>";
        }
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫", err);
        gallery.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫.</p>";
    }

    // –ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
    if (token) {
        try {
            const res = await fetch(`${API_URL}/profile`, {
                headers: { Authorization: "Bearer " + token }
            });
            const user = await res.json();
            if (user.role === "admin" || user.subscription === "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫") {
                document.getElementById("dev-panel").style.display = "block";
            }
        } catch {}
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
    document.getElementById("uploadImageBtn").addEventListener("click", async () => {
        const file = document.getElementById("imageUpload").files[0];
        const title = document.getElementById("imageTitle").value;
        const price = document.getElementById("imagePrice").value;

        if (!file || !price) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏ —É–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É!");

        const formData = new FormData();
        formData.append("image", file);
        formData.append("title", title);
        formData.append("price", price);

        const res = await fetch(`${API_URL}/upload-image`, {
            method: "POST",
            headers: { Authorization: "Bearer " + token },
            body: formData
        });
        const result = await res.json();
        if (result.success) {
            alert("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!");
            location.reload();
        } else {
            alert("–û—à–∏–±–∫–∞: " + result.error);
        }
    });
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—É–ø–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
async function checkPurchase(imageId) {
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_URL}/check-purchase-image`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
        },
        body: JSON.stringify({ imageId })
    });
    const result = await res.json();
    if (result.success && result.purchased) {
        const actions = document.getElementById(`actions-${imageId}`);
        actions.innerHTML = `<a href="/images/${result.file}" download><button>–°–∫–∞—á–∞—Ç—å</button></a>`;
    }
}

// –ü–æ–∫—É–ø–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏
async function buyImage(id) {
    const token = localStorage.getItem("token");
    if (!token) return alert("–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏!");

    const res = await fetch(`${API_URL}/buy-image`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
        },
        body: JSON.stringify({ imageId: id })
    });
    const result = await res.json();

    if (result.success) {
        alert(result.message);
        location.reload();
    } else {
        alert("–û—à–∏–±–∫–∞: " + result.error);
    }
}

// üö´ –ê–Ω—Ç–∏—Å–∫—Ä–∏–Ω—à–æ—Ç
document.addEventListener("keydown", (e) => {
    if (e.key === "PrintScreen") {
        document.body.style.filter = "brightness(0%)";
        setTimeout(() => { document.body.style.filter = "brightness(100%)"; }, 2000);
        alert("–°–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã!");
    }
    if (e.ctrlKey && (e.key === "c" || e.key === "s" || e.key === "p")) {
        e.preventDefault();
        alert("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ!");
    }
});
document.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    alert("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ!");
});
</script>
</body>
</html>
