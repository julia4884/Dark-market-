<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–Ω–∏–≥–∏ ‚Äî Dark Market Ultra</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background:#111; color:#eee; font-family:Arial,sans-serif; text-align:center; padding:20px; }
        nav a { margin:0 10px; color:#eee; text-decoration:none; }
        nav a:hover { color:crimson; }
        .gallery { display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:20px; margin-top:20px; }
        .book-card { background:#1c1c1c; padding:15px; border-radius:8px; transition:transform 0.2s; }
        .book-card:hover { transform:scale(1.05); }
        .book-card img { width:100%; height:200px; object-fit:cover; border-radius:6px; }
        .price { color:crimson; font-weight:bold; margin:8px 0; }
        button { background:crimson; border:none; padding:8px 15px; border-radius:6px; color:white; cursor:pointer; }
        button:hover { background:darkred; }
        #dev-panel { margin-top:30px; padding:20px; background:#1c1c1c; border-radius:10px; display:none; }
        input { margin:5px; padding:8px; width:80%; background:#222; color:#eee; border:none; border-radius:6px; }
        progress { width:100%; height:20px; margin-top:10px; display:none; }
    </style>
</head>
<body>
<header>
    <h1>–ö–Ω–∏–≥–∏ ‚Äî Dark Market Ultra</h1>
    <nav>
        <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="home.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        <a href="games.html">–ò–≥—Ä—ã</a>
        <a href="movies.html">–§–∏–ª—å–º—ã</a>
        <a href="music.html">–ú—É–∑—ã–∫–∞</a>
        <a href="images.html">–ö–∞—Ä—Ç–∏–Ω–∫–∏</a>
        <a href="books.html">–ö–Ω–∏–≥–∏</a>
        <a href="apps.html">–ü—Ä–æ–≥—Ä–∞–º–º—ã</a>
        <a href="tools.html">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</a>
    </nav>
    <p>–ö–Ω–∏–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è üìñ</p>
</header>

<main>
    <div class="gallery" id="gallery"></div>

    <!-- –ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
    <section id="dev-panel">
        <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É</h2>
        <input type="file" id="bookUpload" accept=".pdf,.epub,.txt"><br>
        <input type="file" id="coverUpload" accept="image/*"><br>
        <input type="text" id="bookTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏"><br>
        <input type="number" step="0.01" id="bookPrice" placeholder="–¶–µ–Ω–∞ (‚Ç¨)"><br>
        <progress id="uploadProgress" value="0" max="100"></progress><br>
        <button id="uploadBookBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </section>
</main>

<footer>
    <p>¬© Dark Market Ultra ¬© 2025</p>
</footer>

<script src="config.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("token");
    const gallery = document.getElementById("gallery");
    const progressBar = document.getElementById("uploadProgress");

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–Ω–∏–≥–∏
    async function loadBooks() {
        try {
            const res = await fetch(`${API_URL}/books/list`);
            const data = await res.json();

            gallery.innerHTML = "";
            if (data.success && data.books.length > 0) {
                data.books.forEach(book => {
                    const div = document.createElement("div");
                    div.className = "book-card";
                    div.innerHTML = `
                        <img src="${API_URL + book.cover}" alt="${book.title}">
                        <p><b>${book.title}</b></p>
                        <p class="price">${book.price} ‚Ç¨</p>
                        <div id="actions-${book.id}">
                            <button onclick="buyBook(${book.id})">–ö—É–ø–∏—Ç—å</button>
                        </div>
                    `;
                    gallery.appendChild(div);

                    if (token) checkPurchase(book.id);
                });
            } else {
                gallery.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–Ω–∏–≥.</p>";
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥", err);
            gallery.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥.</p>";
        }
    }
    await loadBooks();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
    if (token) {
        try {
            const res = await fetch(`${API_URL}/profile`, {
                headers: { Authorization: "Bearer " + token }
            });
            const user = await res.json();
            if (user.role === "admin" || user.subscription === "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫") {
                document.getElementById("dev-panel").style.display = "block";
            }
        } catch {}
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏
    document.getElementById("uploadBookBtn").addEventListener("click", () => {
        const bookFile = document.getElementById("bookUpload").files[0];
        const coverFile = document.getElementById("coverUpload").files[0];
        const title = document.getElementById("bookTitle").value;
        const price = document.getElementById("bookPrice").value;

        if (!bookFile || !coverFile || !price) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª, –æ–±–ª–æ–∂–∫—É –∏ —É–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É!");

        const formData = new FormData();
        formData.append("book", bookFile);
        formData.append("cover", coverFile);
        formData.append("title", title);
        formData.append("price", price);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", `${API_URL}/upload-book`);
        xhr.setRequestHeader("Authorization", "Bearer " + token);

        progressBar.style.display = "block";
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                progressBar.value = (e.loaded / e.total) * 100;
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                alert("–ö–Ω–∏–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!");
                loadBooks();
                progressBar.style.display = "none";
            } else {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
            }
        };
        xhr.send(formData);
    });
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—É–ø–∫–∏ –∫–Ω–∏–≥–∏
async function checkPurchase(bookId) {
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_URL}/check-purchase-book`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
        },
        body: JSON.stringify({ bookId })
    });
    const result = await res.json();
    if (result.success && result.purchased) {
        const actions = document.getElementById(`actions-${bookId}`);
        actions.innerHTML = `<a href="${API_URL}/books/${result.file}" download><button>–°–∫–∞—á–∞—Ç—å</button></a>`;
    }
}

// –ü–æ–∫—É–ø–∫–∞ –∫–Ω–∏–≥–∏
async function buyBook(id) {
    const token = localStorage.getItem("token");
    if (!token) return alert("–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏!");

    const res = await fetch(`${API_URL}/buy-book`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
        },
        body: JSON.stringify({ bookId: id })
    });
    const result = await res.json();

    if (result.success) {
        alert(result.message);
        location.reload();
    } else {
        alert("–û—à–∏–±–∫–∞: " + result.error);
    }
}
</script>
</body>
</html>
