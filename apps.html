<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Программы — Dark Market Ultra</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Подключение общего хедера -->
  <div id="header-placeholder"></div>

  <main>
    <h1>Программы</h1>

    <!-- Галерея приложений -->
    <div id="gallery" class="gallery"></div>

    <!-- Форма загрузки (только для админов/разработчиков) -->
    <section id="uploadSection" class="upload-section" style="display:none;">
      <h2>Загрузить программу</h2>
      <form id="uploadForm">
        <input type="text" id="appTitle" placeholder="Название программы" required>
        <input type="number" id="appPrice" placeholder="Цена (0 = бесплатно)" required>
        <input type="file" id="appFile" accept=".exe,.apk,.zip,.rar" required>
        <button type="submit">Загрузить</button>
        <div id="uploadProgress">0%</div>
      </form>
    </section>
  </main>

  <script src="header.js"></script>
  <script src="script.js"></script>
  <script>
    const API_URL = "https://dark-market-backend.onrender.com";

    async function loadApps() {
      try {
        const res = await fetch(API_URL + "/apps/list");
        const data = await res.json();

        if (data.success) {
          const gallery = document.getElementById("gallery");
          gallery.innerHTML = "";

          data.items.forEach(item => {
            const card = document.createElement("div");
            card.className = "card";

            const title = document.createElement("h3");
            title.textContent = item.title;

            const downloadBtn = document.createElement("button");
            if (item.price === 0) {
              downloadBtn.textContent = "Скачать бесплатно";
              downloadBtn.onclick = () => window.location.href = API_URL + "/uploads/" + item.file;
            } else {
              downloadBtn.textContent = "Купить за " + item.price + "€";
              downloadBtn.onclick = () => alert("Оплата через PayPal скоро будет доступна!");
            }

            card.appendChild(title);
            card.appendChild(downloadBtn);
            gallery.appendChild(card);
          });
        }
      } catch (err) {
        console.error("Ошибка загрузки программ:", err);
      }
    }

    // Проверка роли пользователя
    async function checkRole() {
      const token = localStorage.getItem("token");
      if (!token) return;

      try {
        const res = await fetch(API_URL + "/auth/me", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();

        if (data.success && (data.user.role === "admin" || data.user.role === "developer")) {
          document.getElementById("uploadSection").style.display = "block";
        }
      } catch (err) {
        console.error("Ошибка проверки роли:", err);
      }
    }

    // Обработка загрузки файла
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData();
      formData.append("title", document.getElementById("appTitle").value);
      formData.append("price", document.getElementById("appPrice").value);
      formData.append("file", document.getElementById("appFile").files[0]);

      try {
        const res = await fetch(API_URL + "/apps/upload", {
          method: "POST",
          headers: { "Authorization": "Bearer " + localStorage.getItem("token") },
          body: formData
        });

        const data = await res.json();
        if (data.success) {
          alert("Программа успешно загружена!");
          loadApps();
        } else {
          alert("Ошибка: " + data.message);
        }
      } catch (err) {
        console.error("Ошибка при загрузке:", err);
      }
    });

    loadApps();
    checkRole();
  </script>
</body>
</html>
